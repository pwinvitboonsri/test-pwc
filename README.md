# Catalogue

A production-minded Next.js 14 catalogue experience backed by Prisma, SQLite, and Zod. The application ships with cursor-based pagination, URL-driven filtering and sorting, and a review workflow that maintains aggregate product statistics.

## Tech stack

- [Next.js 14 (App Router)](https://nextjs.org/)
- [TypeScript](https://www.typescriptlang.org/)
- [Tailwind CSS](https://tailwindcss.com/)
- [Prisma ORM](https://www.prisma.io/) with SQLite
- [Zod](https://zod.dev/) for runtime validation

## Local development

1. Install dependencies:

   ```bash
   npm ci
   ```

2. Generate the Prisma client and create the SQLite database:

   ```bash
   npm run prisma:gen
   npm run prisma:migrate
   ```

3. Seed the database with 25k+ products and reviews:

   ```bash
   npm run seed
   ```

4. Start the development server:

   ```bash
   npm run dev
   ```

   The app runs at [http://localhost:3000](http://localhost:3000).

> **Environment:** The app expects `DATABASE_URL` to point to a SQLite database (default `file:./dev.db`). Override it in `.env` if you keep the database outside the repo.

## Database seeding

`npm run seed` populates the catalogue with more than 25,000 products across Phones, Books, Laptops, Home, Toys, Sports, and Clothing categories. Each product receives up to five synthetic reviews, and aggregate rating/count figures are synchronised.

The same script powers containerised deployments through `prisma/seed.js`, which bootstraps `ts-node` when executed by Node.

## Docker usage

Build and run the service:

```bash
docker compose up --build
```

The container exposes the app on port `3000`, mounts the SQLite database under the `dbdata` named volume, and executes migrations plus the seed script before starting the server.

## API contract

### `GET /api/products`

Query parameters:

- `category`: optional comma-separated category list.
- `min` / `max`: optional numeric price bounds.
- `sort`: `price` | `rating` | `name` (default `rating`).
- `dir`: `asc` | `desc` (default `desc`).
- `pageSize`: page size between 12 and 96 (default 24).
- `cursor`: opaque cursor generated by the API for subsequent pages.

Response:

```json
{
  "items": [
    {
      "id": "string",
      "name": "string",
      "description": "string",
      "category": "string",
      "price": 199.99,
      "imageUrl": "https://...",
      "averageRating": 4.5,
      "reviewCount": 120
    }
  ],
  "nextCursor": "string | null"
}
```

### `GET /api/products/:id`

Returns the product plus aggregate review statistics:

```json
{
  "product": { ...ProductDTO },
  "stats": {
    "reviewCount": 42,
    "avgRating": 4.6
  }
}
```

### `GET /api/reviews`

- Required `productId` parameter.
- Optional `pageSize` (1–50, default 10) and `cursor` (createdAt/id pair).
- Returns `{ items: ReviewDTO[], nextCursor }`.

### `POST /api/reviews`

Accepts `productId`, `authorName`, `title`, `body`, and `rating` (1–5). Validates the payload with Zod, inserts the review, and recomputes the product’s average rating and review count inside a transaction.

## Acceptance checklist

- [x] Next.js 14 App Router with strict TypeScript.
- [x] Prisma + SQLite schema with indexed catalogue models and seeded dataset (>25k products).
- [x] URL-controlled filters, sorting, and cursor pagination with tie-breaks by id.
- [x] Review creation with end-to-end validation and aggregate updates.
- [x] Dockerfile and Compose setup running migrations, seeding, and production start.
